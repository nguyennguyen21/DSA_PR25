@page
@model DSA_PR25.Pages.Profile.ProgressModel
@{
    ViewData["Title"] = "Tiến độ học tập";
}

<div class="container mt-4">
    <h2><i class="bi bi-graph-up"></i> Tiến độ học tập của bạn</h2>
    <hr />

    <!-- Thông tin người dùng & Badge -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Thông tin cá nhân</h5>
        </div>
        <div class="card-body">
            @if (Model.CurrentUser != null)
            {
                <p><strong>Họ và tên:</strong> @Model.CurrentUser.Fullname</p>
                <p><strong>Tên đăng nhập:</strong> @Model.CurrentUser.Username</p>
                <p><strong>EXP:</strong> @Model.CurrentUser.Exp</p>

                if (Model.CurrentBadge != null)
                {
                    <p><strong>Badge hiện tại:</strong></p>
                    <div class="d-flex align-items-center">
                        @if (!string.IsNullOrEmpty(Model.CurrentBadge.Image))
                        {
                            <img src="@Model.CurrentBadge.Image.Trim()" 
                                 alt="@Model.CurrentBadge.Name" 
                                 class="rounded me-2" 
                                 width="50" height="50" 
                                 style="object-fit: contain;" />
                        }
                        <span><strong>@Model.CurrentBadge.Name</strong> (Cấp @Model.CurrentBadge.BadgeLevel)</span>
                    </div>
                }
            }
            else
            {
                <p class="text-muted">Không tìm thấy thông tin người dùng.</p>
            }
        </div>
    </div>

    <!-- Lịch sử làm bài -->
    <div class="card">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Lịch sử làm bài gần đây</h5>
        </div>
        <div class="card-body">
            @if (Model.ExamResults != null && Model.ExamResults.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Ngày thi</th>
                                <th>Tổng câu</th>
                                <th>Đúng</th>
                                <th>Điểm Bloom</th>
                                <th>Tỷ lệ đúng</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var result in Model.ExamResults)
                            {
                                var accuracy = result.TotalQuestions > 0 
                                    ? (result.CorrectAnswers * 100.0 / result.TotalQuestions) 
                                    : 0;
                                <tr>
                                    <td>@(result.ExamDate?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                    <td>@result.TotalQuestions</td>
                                    <td>@result.CorrectAnswers</td>
                                    <td><strong>@result.TotalScore.ToString("F1")</strong></td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-info" 
                                                 role="progressbar" 
                                                 style="width: @(accuracy)%;">
                                                @accuracy.ToString("F0")%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p class="text-muted">Bạn chưa làm bài thi nào.</p>
            }
        </div>
    </div>

    <div class="mt-3">
        <a asp-page="/Exam/Setup" class="btn btn-primary">
            <i class="bi bi-pencil-square"></i> Làm bài thi mới
        </a>
        <a asp-page="/Index" class="btn btn-outline-secondary">
            <i class="bi bi-house"></i> Quay về trang chủ
        </a>
    </div>
</div>